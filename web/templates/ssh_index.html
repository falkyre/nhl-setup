<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal | NLS Control Hub</title>
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />

    <style>
        /* 1. Define the custom font using Flask's static folder */
        @font-face {
            font-family: 'MesloLGS NF';
            src: url("{{ url_for('static', filename='fonts/MesloLGS_NF_Regular.ttf') }}") format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        .dropdown-item.active {
            font-weight: bold;
        }

        /* Logo Header CSS */
        .logo-header {
            max-width: 300px;
            width: 70%;
            height: auto;
            margin-bottom: 1rem;
            /* Default (dark mode) style */
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            transition: background-color 0.2s ease-in-out, padding 0.2s ease-in-out;
        }

        /* Light mode style */
        [data-bs-theme="light"] .logo-header {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.375rem;
        }

        /* CSS to toggle logos */
        .logo-light {
            display: none;
        }

        .logo-dark {
            display: inline-block;
        }

        [data-bs-theme="light"] .logo-light {
            display: inline-block;
        }

        [data-bs-theme="light"] .logo-dark {
            display: none;
        }

        /* Terminal Specific */
        #terminal-container {
            width: 100%;
            height: 70vh;
            background-color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            /* Hidden by default until login */
        }

        .xterm-viewport {
            overflow-y: auto;
        }

        #login-card {
            max-width: 400px;
            margin: 0 auto;
        }
    </style>

    <script>
        (function () {
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-bs-theme', theme);
            };
            const savedTheme = localStorage.getItem('theme') || 'auto';

            if (savedTheme === 'light' || savedTheme === 'dark') {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        })();
    </script>
</head>

<body class="container my-4">

    <div class="d-flex justify-content-end mb-2">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="theme-toggle-button"
                data-bs-toggle="dropdown" aria-expanded="false">
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="theme-toggle-button">
                <li><a class="dropdown-item" href="#" data-theme-value="light"><i class="bi bi-sun-fill me-2"></i>
                        Light</a></li>
                <li><a class="dropdown-item" href="#" data-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i>
                        Dark</a></li>
                <li><a class="dropdown-item" href="#" data-theme-value="auto"><i class="bi bi-circle-half me-2"></i>
                        Auto</a></li>
            </ul>
        </div>
    </div>

    <div class="text-center">
        <a href="/">
            <img src="/assets/images/logo-lite.svg" class="logo-header logo-light" alt="Scoreboard Logo">
            <img src="/assets/images/logo.svg" class="logo-header logo-dark" alt="Scoreboard Logo">
        </a>
    </div>

    <nav class="nav nav-pills flex-column flex-sm-row justify-content-center text-center nav-fill mb-4">
        <a class="nav-link" id="nav-home" href="/">HOME</a>
        <a class="nav-link" id="nav-config" href="/config">CONFIGURATOR</a>
        <a class="nav-link" id="nav-plugins" href="/plugins">PLUGINS</a>
        <a class="nav-link" id="nav-utilities" href="/utilities">UTILITIES</a>
        <a class="nav-link active" id="nav-terminal" href="/terminal">TERMINAL</a>
        <a class="nav-link" id="nav-supervisor" href="/supervisor" style="display: none;">SUPERVISOR</a>
    </nav>

    <div class="container">
        <!-- Login Form -->
        <div id="login-container" class="my-5">
            <div class="card" id="login-card">
                <div class="card-header text-center">
                    <h4><i class="bi bi-terminal-fill me-2"></i> SSH Login</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted small text-center">Connect to local server (127.0.0.1:22)</p>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" placeholder="pi" autofocus>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Password">
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" onclick="connectSSH()">Login</button>
                    </div>
                    <div id="error-msg" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Terminal Output -->
        <div id="terminal-wrapper" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5><i class="bi bi-terminal me-2"></i> Terminal Session</h5>
                <button class="btn btn-sm btn-danger" onclick="disconnectSSH()">Logout</button>
            </div>
            <div id="terminal-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.min.js"></script>

    <script>
        // --- Theme Logic ---
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const themeLinks = document.querySelectorAll('a[data-theme-value]');
        const autoMediaMatch = window.matchMedia('(prefers-color-scheme: dark)');

        const icons = {
            light: '<i class="bi bi-sun-fill me-2"></i> Light',
            dark: '<i class="bi bi-moon-stars-fill me-2"></i> Dark',
            auto: '<i class="bi bi-circle-half me-2"></i> Auto'
        };

        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-bs-theme', theme);
        };

        const applyHtmlTheme = (theme) => {
            if (theme === 'light' || theme === 'dark') {
                applyTheme(theme);
            } else { // 'auto'
                applyTheme(autoMediaMatch.matches ? 'dark' : 'light');
            }
        };

        const updateUI = (theme) => {
            themeToggleButton.innerHTML = icons[theme];
            themeLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-theme-value') === theme);
            });
        };

        const currentTheme = localStorage.getItem('theme') || 'auto';
        updateUI(currentTheme);

        themeLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const newTheme = link.getAttribute('data-theme-value');
                localStorage.setItem('theme', newTheme);
                applyHtmlTheme(newTheme);
                updateUI(newTheme);
            });
        });

        // --- Terminal Logic ---
        const socket = io();
        let term, fitAddon;
        let sessionToken = localStorage.getItem('ssh_session_token');

        // On load, check if we have a token
        if (sessionToken) {
            console.log("Found existing session token, attempting resume...");
            // Hide login, show terminal container (content will appear on success)
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('terminal-wrapper').style.display = 'block';
            document.getElementById('terminal-container').style.display = 'block';

            initTerminal();
            socket.emit('ssh_resume', { token: sessionToken });
        } else {
            console.log("No session token found.");
        }

        function connectSSH() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-msg');

            if (!user || !pass) {
                errorDiv.textContent = "Username and Password required.";
                errorDiv.style.display = 'block';
                return;
            }
            errorDiv.style.display = 'none';

            // Disable button
            document.querySelector('#login-card button').disabled = true;
            document.querySelector('#login-card button').textContent = 'Connecting...';

            socket.emit('ssh_login', { username: user, password: pass });
        }

        socket.on('login_status', function (response) {
            const btn = document.querySelector('#login-card button');

            if (response.status === 'success') {
                // Store token
                sessionToken = response.token;
                localStorage.setItem('ssh_session_token', sessionToken);

                document.getElementById('login-container').style.display = 'none';
                document.getElementById('terminal-wrapper').style.display = 'block';
                document.getElementById('terminal-container').style.display = 'block';

                // Reset login form for next time
                btn.disabled = false;
                btn.textContent = 'Login';
                document.getElementById('password').value = '';

                // Only init terminal if not already done (resume flow might do it earlier)
                if (!term) initTerminal();

                // If resuming, we might have missed fit, so fit again
                if (fitAddon) setTimeout(() => fitAddon.fit(), 100);

            } else {
                // Login failed or resume failed
                localStorage.removeItem('ssh_session_token'); // Clear invalid token
                sessionToken = null;

                document.getElementById('login-container').style.display = 'block';
                document.getElementById('terminal-wrapper').style.display = 'none';
                document.getElementById('terminal-container').style.display = 'none';

                const errorDiv = document.getElementById('error-msg');
                errorDiv.textContent = "Login Failed: " + (response.message || "Unknown error");
                errorDiv.style.display = 'block';

                btn.disabled = false;
                btn.textContent = 'Login';

                if (term) {
                    term.dispose();
                    term = null;
                }
            }
        });

        function initTerminal() {
            if (term) return; // already initialized

            term = new Terminal({
                cursorBlink: true,
                fontFamily: '"MesloLGS NF", monospace',
                fontSize: 14,
                lineHeight: 1.1,
                theme: {
                    background: '#000000',
                    foreground: '#ffffff'
                }
            });

            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            try {
                const webglAddon = new WebglAddon.WebglAddon();
                term.loadAddon(webglAddon);
            } catch (e) {
                console.warn("WebGL addon could not be loaded", e);
            }

            term.open(document.getElementById('terminal-container'));
            fitAddon.fit();

            // Handle Resize
            new ResizeObserver(() => {
                try { fitAddon.fit(); } catch (e) { }
            }).observe(document.getElementById('terminal-container'));

            term.onData(data => {
                // Send token with every input to verify session
                socket.emit('input', { data: data, token: sessionToken });
            });

            term.focus();

            socket.on('response', function (msg) {
                term.write(msg.data);
            });
        }

        function disconnectSSH() {
            if (sessionToken) {
                socket.emit('ssh_logout', { token: sessionToken });
                localStorage.removeItem('ssh_session_token');
            }
            location.reload();
        }

        document.getElementById("password").addEventListener("keypress", function (event) {
            if (event.key === "Enter") connectSSH();
        });

        // --- Fetch Status for Header Config ---
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.supervisor_available) {
                    document.getElementById('nav-supervisor').style.display = 'block';
                }
            })
            .catch(console.error);

    </script>

    <footer class="mt-5 pt-4 border-top text-center">
        <p class="text-muted">Find help or contribute:</p>
        <div class="d-flex justify-content-center gap-4 fs-2">
            <a href="https://github.com/falkyre/nhl-led-scoreboard" title="GitHub Repository"
                class="text-body-secondary"><i class="bi bi-github"></i></a>
            <a href="https://github.com/falkyre/nhl-led-scoreboard/issues" title="Report an Issue"
                class="text-body-secondary"><i class="bi bi-bug-fill"></i></a>
            <a href="https://github.com/falkyre/nhl-led-scoreboard/wiki" title="Project Wiki"
                class="text-body-secondary"><i class="bi bi-book-half"></i></a>
            <a href="https://github.com/falkyre/nhl-led-scoreboard/blob/main/README.md" title="README"
                class="text-body-secondary"><i class="bi bi-file-text-fill"></i></a>
        </div>
    </footer>
</body>

</html>