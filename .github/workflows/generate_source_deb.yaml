name: Generate APT Source Package

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-keys
          gpg --list-secret-keys

      - name: Build APT Source Package
        id: build
        run: |
          # Define variables
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          PAGE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          
          # Version - try to read from file, else default
          if [ -f web/VERSION ]; then
            PKG_VERSION=$(cat web/VERSION)
          else
            PKG_VERSION="1.0.0"
          fi
          
          PKG_NAME="nls-controlhub-apt-source"
          STAGING="apt-source-staging"
          
          mkdir -p "$STAGING"/etc/apt/trusted.gpg.d
          mkdir -p "$STAGING"/etc/apt/sources.list.d
          mkdir -p "$STAGING"/DEBIAN
          
          # Get Key ID
          KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec:/ {print $5; exit}')
          if [ -z "$KEY_ID" ]; then
            echo "Error: No secret key found."
            exit 1
          fi
          
          # Export public key
          gpg --export "$KEY_ID" > "$STAGING/etc/apt/trusted.gpg.d/nls-controlhub.gpg"
          
          # Create sources.list
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/nls-controlhub.gpg] $PAGE_URL/repo ./" > "$STAGING/etc/apt/sources.list.d/nls-controlhub.list"
          
          # Create Control File
          cat <<EOF > "$STAGING/DEBIAN/control"
          Package: $PKG_NAME
          Version: $PKG_VERSION
          Architecture: all
          Maintainer: Sean Ostermann <falkyre@gmail.com>
          Description: APT configuration for NLS Control Hub
           This package installs the GPG signing key and repository configuration
           for the NLS Control Hub.
          EOF
          
          # Build Package
          mkdir -p out
          DEB_NAME="${PKG_NAME}_${PKG_VERSION}_all.deb"
          dpkg-deb --build --root-owner-group "$STAGING" "out/$DEB_NAME"
          
          echo "deb_path=out/$DEB_NAME" >> $GITHUB_OUTPUT
          echo "deb_name=$DEB_NAME" >> $GITHUB_OUTPUT
          
          # Cleanup
          rm -rf "$STAGING"

      - name: Update Repository
        run: |
          # Configure Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Switch to gh-pages
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            git pull origin gh-pages
          else
            echo "gh-pages branch not found!"
            exit 1
          fi
          
          # Copy new package
          mkdir -p repo
          # The 'out' directory is preserved across checkout because it is untracked
          cp ${{ steps.build.outputs.deb_path }} repo/
          
          # Retrieve Key ID again
          KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec:/ {print $5; exit}')
          
          # Update Apt Indices
          sudo apt-get update && sudo apt-get install -y --no-install-recommends dpkg-dev apt-utils
          
          cd repo
          dpkg-scanpackages --multiversion . > Packages
          gzip -k -f Packages
          apt-ftparchive \
            -o APT::FTPArchive::Release::Origin="nls-controlhub" \
            -o APT::FTPArchive::Release::Label="nls-controlhub" \
            -o APT::FTPArchive::Release::Suite="stable" \
            -o APT::FTPArchive::Release::Codename="nls-controlhub" \
            -o APT::FTPArchive::Release::Architectures="armhf arm64 all" \
            -o APT::FTPArchive::Release::Components="main" \
            -o APT::FTPArchive::Release::Description="NHL LED Scoreboard Control Hub Repository" \
            release . > Release
          
          # Sign
          rm -f Release.gpg InRelease
          gpg --default-key "$KEY_ID" -abs -o - Release > Release.gpg
          gpg --default-key "$KEY_ID" --clearsign -o - Release > InRelease
          
          # Export public key (ensure it's there)
          gpg --armor --export "$KEY_ID" > KEY.gpg
          
          cd ..
          
          # Commit and Push
          git add repo/
          git commit -m "Update apt-source package (${{ steps.build.outputs.deb_name }})" || echo "No changes to commit"
          git push origin gh-pages
