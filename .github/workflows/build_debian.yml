name: Build Debian Packages for NLS Control Hub

on:
  workflow_run:
    workflows: ["Build NLS Control Hub Executables"]
    types:
      - completed

jobs:
  determine-matrix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Determine which artifacts were built
        id: set-matrix
        uses: actions/github-script@v6
        with:
          script: |
            let all_artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            let matrix = { include: [] };
            for (let artifact of all_artifacts.data.artifacts) {
              if (artifact.name.startsWith('nls_controlhub-')) {
                const suffix = artifact.name.replace('nls_controlhub-', '').trim();
                let arch = '';
                if (suffix.includes('armv7')) {
                  arch = 'armhf';
                } else if (suffix.includes('arm64')) {
                  arch = 'arm64';
                }
                if (arch) {
                  matrix.include.push({ suffix: suffix, arch: arch });
                }
              }
            }
            core.setOutput('matrix', JSON.stringify(matrix));
            if (matrix.include.length === 0) {
              console.log("No matching artifacts found. Skipping packaging.");
            } else {
              console.log("Found matching artifacts. Proceeding with matrix:", JSON.stringify(matrix));
            }

  build-debian-package:
    needs: determine-matrix
    # Only run this job if the matrix is not empty
    if: ${{ needs.determine-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-matrix.outputs.matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Executable Artifact
        uses: actions/download-artifact@v4
        with:
          name: nls_controlhub-${{ matrix.suffix }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./executable

      - name: Set up Debian package structure
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/etc/systemd/system
          mkdir -p debian/etc/nls_controlhub
          mkdir -p debian/usr/local/bin

      - name: Get version from VERSION file
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Create control file
        run: |
          cat <<EOF > debian/DEBIAN/control
          Package: nls-controlhub
          Version: ${{ steps.version.outputs.version }}
          Architecture: ${{ matrix.arch }}
          Maintainer: falkyre <falkyre@example.com>
          Description: NHL LED Scoreboard Control Hub.
           A web-based control panel for the NHL LED Scoreboard.
          EOF

      - name: Copy files to package structure
        run: |
          cp packaging/nls_controlhub.service debian/etc/systemd/system/
          cp web/config.toml debian/etc/nls_controlhub/
          mv ./executable/nls_controlhub-${{ matrix.suffix }} debian/usr/local/bin/nls_controlhub
          chmod +x debian/usr/local/bin/nls_controlhub

      - name: Build Debian package
        run: dpkg-deb --build debian nls-controlhub-${{ matrix.suffix }}.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: nls-controlhub-deb-${{ matrix.suffix }}
          path: nls-controlhub-${{ matrix.suffix }}.deb
