name: Build Debian Packages for NLS Control Hub

on:
  workflow_run:
    workflows: ["Build NLS Control Hub Executables"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'Name of the workflow to get artifacts from'
        required: true
        default: 'Build NLS Control Hub Executables'
        type: choice
        options:
        - Build NLS Control Hub Executables
        - Build Web Interface

jobs:
  determine-matrix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      run_id: ${{ steps.set-matrix.outputs.run_id }}
    steps:
      - name: Determine which artifacts were built
        id: set-matrix
        uses: actions/github-script@v6
        with:
          script: |
            let run_id;
            if (context.eventName === 'workflow_run') {
              run_id = context.payload.workflow_run.id;
              console.log(`Triggered by workflow_run, run_id: ${run_id}`);
            } else { // workflow_dispatch
              console.log("Triggered by workflow_dispatch, finding last successful run...");
              const workflow_name = context.payload.inputs.workflow_name;
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow_name,
                status: 'success',
                branch: 'main'
              });
              if (runs.data.workflow_runs.length > 0) {
                run_id = runs.data.workflow_runs[0].id;
                console.log(`Found last successful run for '${workflow_name}', run_id: ${run_id}`);
              } else {
                core.setFailed(`No successful runs found on main branch for workflow: ${workflow_name}`);
                return;
              }
            }
            core.setOutput('run_id', run_id);

            const all_artifacts_response = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id,
            });

            console.log("--- All Artifacts ---");
            console.log(JSON.stringify(all_artifacts_response.data.artifacts, null, 2));
            console.log("---------------------");

            let matrix = { include: [] };
            for (let artifact of all_artifacts_response.data.artifacts) {
              console.log(`Processing artifact: Name: '${artifact.name}', ID: ${artifact.id}`);
              if (artifact.name.startsWith('nls_controlhub-')) {
                const suffix = artifact.name.replace('nls_controlhub-', '').trim();
                let arch = '';
                if (suffix.includes('armv7')) {
                  arch = 'armhf';
                } else if (suffix.includes('arm64')) {
                  arch = 'arm64';
                }

                console.log(`  - Suffix: '${suffix}', Arch: '${arch}'`);

                if (arch) {
                  matrix.include.push({ suffix: suffix, arch: arch });
                  console.log(`  - Added to matrix.`);
                } else {
                  console.log("  - Skipped: No valid architecture found in suffix.");
                }
              } else {
                console.log("  - Skipped: Artifact name does not start with 'nls_controlhub-'.");
              }
            }

            core.setOutput('matrix', JSON.stringify(matrix));

            if (matrix.include.length === 0) {
              console.log("Matrix is empty. No packages will be built.");
            } else {
              console.log("Generated Matrix:");
              console.log(JSON.stringify(matrix, null, 2));
            }

  build-debian-package:
    needs: determine-matrix
    # Only run this job if the matrix is not empty
    if: ${{ needs.determine-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-matrix.outputs.matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Executable Artifact
        uses: actions/download-artifact@v4
        with:
          name: nls_controlhub-${{ matrix.suffix }}
          run-id: ${{ needs.determine-matrix.outputs.run_id }}
          path: ./executable

      - name: Set up Debian package structure
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/etc/systemd/system
          mkdir -p debian/etc/nls_controlhub
          mkdir -p debian/usr/local/bin

      - name: Get version from VERSION file
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Create control file
        run: |
          cat <<EOF > debian/DEBIAN/control
          Package: nls-controlhub
          Version: ${{ steps.version.outputs.version }}
          Architecture: ${{ matrix.arch }}
          Maintainer: falkyre <falkyre@example.com>
          Description: NHL LED Scoreboard Control Hub.
           A web-based control panel for the NHL LED Scoreboard.
          EOF

      - name: Copy files to package structure
        run: |
          cp packaging/nls_controlhub.service debian/etc/systemd/system/
          cp web/config.toml debian/etc/nls_controlhub/
          mv ./executable/nls_controlhub-${{ matrix.suffix }} debian/usr/local/bin/nls_controlhub
          chmod +x debian/usr/local/bin/nls_controlhub

      - name: Build Debian package
        run: dpkg-deb --build debian nls-controlhub-${{ matrix.suffix }}.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: nls-controlhub-deb-${{ matrix.suffix }}
          path: nls-controlhub-${{ matrix.suffix }}.deb
